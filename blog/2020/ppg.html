<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Afonso Raposo | Measuring Your Heart Rate Using Your Phone‚Äôs Camera and Flutter</title>
<meta name="description" content="Personal website.
">

<!-- Open Graph -->

<meta property="og:site_name" content="Personal website.
" />
<meta property="og:type" content="object" />
<meta property="og:title" content="" />
<meta property="og:url" content="https://afonsoraposo.com/blog/2020/ppg" />
<meta property="og:description" content="Measuring Your Heart Rate Using Your Phone‚Äôs Camera and Flutter" />
<meta property="og:image" content="https://github.com/Afonsocraposo/afonsocraposo.github.io/raw/master/assets/img/coding.jpg" />


<!-- Bootstrap & MDB -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css" integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

<!-- Code Syntax Highlighting -->
<link rel="stylesheet" href="https://gitcdn.link/repo/jwarby/jekyll-pygments-themes/master/github.css" />

<!-- Styles -->

<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üë®üèª‚Äçüíª</text></svg>">

<link rel="stylesheet" href="/assets/css/main.css">

<link rel="canonical" href="/blog/2020/ppg">

<!-- JQuery -->
<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>


<!-- Theming-->

  <script src="/assets/js/theme.js"></script>
  <!-- Load DarkMode JS -->
<script src="/assets/js/dark_mode.js"></script>






    
<!-- MathJax -->
<script type="text/javascript">
  window.MathJax = {
    tex: {
      tags: 'ams'
    }
  };
</script>
<script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js"></script>
<script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>


  </head>

  <body class="fixed-top-nav sticky-bottom-footer">

    <!-- Header -->

    <header>

    <!-- Nav Bar -->
    <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
    <div class="container">
      
      <a class="navbar-brand title font-weight-lighter" href="https://afonsoraposo.com/">
       Afonso Raposo
      </a>
      
      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>
      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">
              About
              
            </a>
          </li>
          
          <!-- Blog -->
          <li class="nav-item active">
            <a class="nav-link" href="/blog/">
              Blog
              
            </a>
          </li>
          
          <!-- Other pages -->
          
          
          
          
          
          
          
          
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/projects/">
                Projects
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/publications/">
                Publications
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/teaching/">
                Teaching
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/assets/pdf/CV_Afonso_Raposo.pdf">
                cv
                
              </a>
          </li>
          
          
          
            <div class = "toggle-container">
              <a id = "light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
              </a>
            </div>
          
        </ul>
      </div>
    </div>
  </nav>

</header>


    <!-- Content -->

    <div class="container mt-5">
      

<div class="post">

  <header class="post-header">
    <h1 class="post-title">Measuring Your Heart Rate Using Your Phone‚Äôs Camera and Flutter</h1>
    <p class="post-meta">April 8, 2020</p>
  </header>

  <article class="post-content">
    <div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        <img class="img-fluid rounded z-depth-1" src="/assets/img/posts/2020-04-08-ppg/header.jpeg" />
    </div>
</div>
<div class="caption">
    Photo by <a href="https://unsplash.com/@simonmigaj" target="_blank" rel="noopener noreferrer">Simon Migaj</a> on <a href="https://unsplash.com/s/photos/heart" target="_blank" rel="noopener noreferrer">Unsplash</a>
</div>

<p>In this article, I‚Äôll explain how you can develop a simple app with Flutter that measures heart rate variability and displays it in a chart using only the phone‚Äôs camera and flash.</p>

<div class="row mt-3">
    <div class="col-sm mt-3 pt-md-0 pl-xl-5 pr-xl-5">
    <div class="col-sm mt-3 pt-md-0 pl-xl-5 pr-xl-5">
    <div class="col-sm mt-3 pt-md-0 pl-xl-5 pr-xl-5">
    <div class="col-sm mt-3 pt-md-0 pl-xl-5 pr-xl-5">
        <img class="img-fluid rounded z-depth-1" src="/assets/img/posts/2020-04-08-ppg/screenshot1.jpeg" />
    </div>
    </div>
    </div>
    </div>
</div>
<div class="caption">
Screenshot of the application.
</div>

<center>
<h1>
. . .
</h1>
</center>

<h1 id="concept"><strong>Concept</strong></h1>

<p>You‚Äôve probably seen or know of devices that people clip to their fingers in hospitals that measure their heart rate, or smartwatches capable of measuring your heart rate. They all have one thing in common: They measure the heart rate with a technique called photoplethysmography.</p>

<h5 id="a-photoplethysmogram-ppg-is-an-optically-obtained-plethysmogram-that-can-be-used-to-detect-blood-volume-changes-in-the-microvascular-bed-of-tissue--wikipedia"><em>A photoplethysmogram (PPG) is an optically obtained plethysmogram that can be used to detect blood volume changes in the microvascular bed of tissue. ‚Äî Wikipedia</em></h5>

<p>Shining a light into a blood irrigated tissue, we can measure the variability of reflected light and extract the variation of blood flow. As we all know, the blood flow is dependent on the heart rate, so we can calculate the heart rate using the blood flow variation.</p>

<div class="row mt-3 text-center">
    <div class="col-sm mt-3 mt-md-0">
        <img class="img-fluid rounded z-depth-1" src="/assets/img/posts/2020-04-08-ppg/ppg.jpeg" />
    </div>
</div>
<div class="caption">
    Vandenberk, et. al. (2017). Clinical Validation of Heart Rate Apps: Mixed-Methods Evaluation Study. JMIR Mhealth Uhealth. 5. e129. <a href="https://doi.org/10.2196/mhealth.7254" target="_blank" rel="noopener noreferrer">10.2196/mhealth.7254</a>.
</div>

<p>So, in our application, we‚Äôll shine the camera‚Äôs flash and measure the intensity reflected using the phone‚Äôs camera. More specifically, we‚Äôll measure the average value of all the pixel‚Äôs intensity of the camera image. Then, if we cover the camera and flash with our finger, the intensity measured will vary with the blood flow.</p>

<center>
<h1>
. . .
</h1>
</center>

<h1 id="code"><strong>Code</strong></h1>

<h3 id="dependencies"><strong>Dependencies</strong></h3>

<p>First, we need to install the dependencies:</p>

<ul>
  <li><strong>charts_flutter</strong> ‚Äî Material Design data visualization library written natively in Dart.</li>
  <li><strong>wakelock</strong> ‚Äî This Flutter plugin allows you to enable and toggle the screen wakelock on Android and iOS, which prevents the screen from turning off automatically.</li>
  <li><strong>camera</strong> ‚Äî A Flutter plugin for iOS and Android allowing access to the device cameras.</li>
</ul>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="nn">...</span>

<span class="na">dependencies</span><span class="pi">:</span>
  <span class="na">flutter</span><span class="pi">:</span>
    <span class="na">sdk</span><span class="pi">:</span> <span class="s">flutter</span>
  <span class="na">cupertino_icons</span><span class="pi">:</span> <span class="s">^0.1.2</span>
  <span class="na">charts_flutter</span><span class="pi">:</span> <span class="s">^0.9.0</span>
  <span class="na">wakelock</span><span class="pi">:</span> <span class="s">^0.1.4+1</span>
  <span class="na">camera</span><span class="pi">:</span> <span class="s">^0.7.0+4</span>
  
<span class="nn">...</span></code></pre></figure>

<h2 id="application"><strong>Application</strong></h2>

<p>Our application‚Äôs interface is divided into three files: <code class="language-plaintext highlighter-rouge">main.dart</code>, <code class="language-plaintext highlighter-rouge">homePage.dart</code>, and <code class="language-plaintext highlighter-rouge">chart.dart</code>.</p>

<p><code class="language-plaintext highlighter-rouge">main.dart</code> - Here we only need to set the HomePage widget as our home widget, so it displays when the application runs:</p>

<figure class="highlight"><pre><code class="language-dart" data-lang="dart"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="s">'package:flutter/material.dart'</span><span class="o">;</span>
<span class="kn">import</span> <span class="s">'package:flutter/services.dart'</span><span class="o">;</span>
<span class="kn">import</span> <span class="s">'homePage.dart'</span><span class="o">;</span>

<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span> <span class="o">=</span><span class="p">&gt;</span> <span class="n">runApp</span><span class="p">(</span><span class="n">MyApp</span><span class="p">());</span>

<span class="kd">class</span> <span class="nc">MyApp</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="p">{</span>
  <span class="nd">@override</span>
  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">MaterialApp</span><span class="p">(</span>
      <span class="nl">title:</span> <span class="s">'PPG'</span><span class="p">,</span>
      <span class="nl">theme:</span> <span class="n">ThemeData</span><span class="p">(</span>
        <span class="nl">brightness:</span> <span class="n">Brightness</span><span class="o">.</span><span class="na">light</span><span class="p">,</span>
      <span class="p">),</span>
      <span class="nl">home:</span> <span class="n">HomePage</span><span class="p">(),</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">HomePage</code> - The core of the application is written on the <code class="language-plaintext highlighter-rouge">homePage.dart</code> file, which is our <code class="language-plaintext highlighter-rouge">HomePage</code> widget.</p>

<p>First, we need to create a <code class="language-plaintext highlighter-rouge">Scaffold</code> and, in its body, insert a centered <code class="language-plaintext highlighter-rouge">IconButton</code>, that will activate or deactivate the camera for the reading process.</p>

<figure class="highlight"><pre><code class="language-dart" data-lang="dart"><span class="kn">import</span> <span class="s">'package:camera/camera.dart'</span><span class="o">;</span>
<span class="kn">import</span> <span class="s">'package:flutter/material.dart'</span><span class="o">;</span>
<span class="kn">import</span> <span class="s">'package:wakelock/wakelock.dart'</span><span class="o">;</span>
<span class="kn">import</span> <span class="s">'chart.dart'</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">HomePage</span> <span class="kd">extends</span> <span class="n">StatefulWidget</span> <span class="p">{</span>
  <span class="nd">@override</span>
  <span class="n">HomePageView</span> <span class="n">createState</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">HomePageView</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">HomePageView</span> <span class="kd">extends</span> <span class="n">State</span><span class="p">&lt;</span><span class="n">HomePage</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="kt">bool</span> <span class="n">_toggled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="nd">@override</span>
  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Scaffold</span><span class="p">(</span>
      <span class="nl">backgroundColor:</span> <span class="n">Colors</span><span class="o">.</span><span class="na">white</span><span class="p">,</span>
      <span class="nl">body:</span> <span class="n">SafeArea</span><span class="p">(</span>
        <span class="nl">child:</span> <span class="n">Center</span><span class="p">(</span>
          <span class="nl">child:</span> <span class="n">IconButton</span><span class="p">(</span>
            <span class="nl">icon:</span> <span class="n">Icon</span><span class="p">(</span><span class="n">_toggled</span> <span class="o">?</span> <span class="n">Icons</span><span class="o">.</span><span class="na">favorite</span> <span class="o">:</span> <span class="n">Icons</span><span class="o">.</span><span class="na">favorite_border</span><span class="p">),</span>
            <span class="nl">color:</span> <span class="n">Colors</span><span class="o">.</span><span class="na">red</span><span class="p">,</span>
            <span class="nl">iconSize:</span> <span class="mi">128</span><span class="p">,</span>
            <span class="nl">onPressed:</span> <span class="p">()</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">_toggled</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">_untoggle</span><span class="p">();</span>
              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">_toggle</span><span class="p">();</span>
              <span class="p">}</span>
            <span class="p">},</span>
          <span class="p">),</span>
        <span class="p">),</span>
      <span class="p">),</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>As one can see, there is a <code class="language-plaintext highlighter-rouge">boolean</code> <code class="language-plaintext highlighter-rouge">_toggled</code> which stores the state of the <code class="language-plaintext highlighter-rouge">IconButton</code>. Now, we only need to define the functions <code class="language-plaintext highlighter-rouge">_toggle</code> and <code class="language-plaintext highlighter-rouge">_untoggle</code>.</p>

<p>For now, these functions will only change the value of the <code class="language-plaintext highlighter-rouge">_toggle</code> variable:</p>

<figure class="highlight"><pre><code class="language-dart" data-lang="dart"><span class="n">_toggle</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
    <span class="n">_toggled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="n">_untoggle</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
    <span class="n">_toggled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">}</span></code></pre></figure>

<p><br /></p>

<div class="row mt-3 text-center">
    <div class="col-sm mt-3 mt-md-0">
        <img class="img-fluid rounded z-depth-1" src="/assets/img/posts/2020-04-08-ppg/untoggled.png" />
    </div>
    <div class="col-sm mt-3 mt-md-0">
        <img class="img-fluid rounded z-depth-1" src="/assets/img/posts/2020-04-08-ppg/toggled.png" />
    </div>
</div>
<div class="caption">
Screenshot of the untoggled and toggled iconButton, respectively.
</div>

<p>The next step, is dividing the screen into three equal parts, using three <code class="language-plaintext highlighter-rouge">Expanded</code> widgets inside a <code class="language-plaintext highlighter-rouge">Column</code>:</p>

<figure class="highlight"><pre><code class="language-dart" data-lang="dart"><span class="nd">@override</span>
<span class="n">Widget</span> <span class="nf">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">Scaffold</span><span class="p">(</span>
    <span class="nl">backgroundColor:</span> <span class="n">Colors</span><span class="o">.</span><span class="na">white</span><span class="p">,</span>
    <span class="nl">body:</span> <span class="n">SafeArea</span><span class="p">(</span>
      <span class="nl">child:</span> <span class="n">Column</span><span class="p">(</span>
        <span class="nl">children:</span> <span class="p">&lt;</span><span class="n">Widget</span><span class="p">&gt;[</span>
          <span class="n">Expanded</span><span class="p">(</span>
            <span class="nl">child:</span> <span class="n">Container</span><span class="p">(</span>
              <span class="nl">color:</span> <span class="n">Colors</span><span class="o">.</span><span class="na">red</span><span class="p">,</span>
            <span class="p">),</span>
          <span class="p">),</span>
          <span class="n">Expanded</span><span class="p">(</span>
            <span class="nl">child:</span> <span class="n">Center</span><span class="p">(</span>
              <span class="nl">child:</span> <span class="n">IconButton</span><span class="p">(</span>
                <span class="nl">icon:</span> <span class="n">Icon</span><span class="p">(</span><span class="n">_toggled</span> <span class="o">?</span> <span class="n">Icons</span><span class="o">.</span><span class="na">favorite</span> <span class="o">:</span> <span class="n">Icons</span><span class="o">.</span><span class="na">favorite_border</span><span class="p">),</span>
                <span class="nl">color:</span> <span class="n">Colors</span><span class="o">.</span><span class="na">red</span><span class="p">,</span>
                <span class="nl">iconSize:</span> <span class="mi">128</span><span class="p">,</span>
                <span class="nl">onPressed:</span> <span class="p">()</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">_toggled</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">_untoggle</span><span class="p">();</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">_toggle</span><span class="p">();</span>
                  <span class="p">}</span>
                <span class="p">},</span>
              <span class="p">),</span>
            <span class="p">),</span>
          <span class="p">),</span>
          <span class="n">Expanded</span><span class="p">(</span>
            <span class="nl">child:</span> <span class="n">Container</span><span class="p">(</span>
              <span class="nl">color:</span> <span class="n">Colors</span><span class="o">.</span><span class="na">black</span><span class="p">,</span>
            <span class="p">),</span>
          <span class="p">),</span>
        <span class="p">],</span>
      <span class="p">),</span>
    <span class="p">),</span>
  <span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<div class="row mt-3">
    <div class="col-sm mt-3 pt-md-0 pl-xl-5 pr-xl-5">
    <div class="col-sm mt-3 pt-md-0 pl-xl-5 pr-xl-5">
    <div class="col-sm mt-3 pt-md-0 pl-xl-5 pr-xl-5">
    <div class="col-sm mt-3 pt-md-0 pl-xl-5 pr-xl-5">
        <img class="img-fluid rounded z-depth-1" src="/assets/img/posts/2020-04-08-ppg/3-parts.png" />
    </div>
    </div>
    </div>
    </div>
</div>
<div class="caption">
Screen divided into 3 equal parts.
</div>

<p>On the bottom <code class="language-plaintext highlighter-rouge">Container</code> we display the real-time chart, where the camera‚Äôs data will be displayed. A margin and round corners were also added to this <code class="language-plaintext highlighter-rouge">Container</code>.</p>

<figure class="highlight"><pre><code class="language-dart" data-lang="dart"><span class="kn">import</span> <span class="s">'package:camera/camera.dart'</span><span class="o">;</span>
<span class="kn">import</span> <span class="s">'package:flutter/material.dart'</span><span class="o">;</span>
<span class="kn">import</span> <span class="s">'package:wakelock/wakelock.dart'</span><span class="o">;</span>
<span class="kn">import</span> <span class="s">'chart.dart'</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">HomePage</span> <span class="kd">extends</span> <span class="n">StatefulWidget</span> <span class="p">{</span>
  <span class="nd">@override</span>
  <span class="n">HomePageView</span> <span class="n">createState</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">HomePageView</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">HomePageView</span> <span class="kd">extends</span> <span class="n">State</span><span class="p">&lt;</span><span class="n">HomePage</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="kt">bool</span> <span class="n">_toggled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="kt">List</span><span class="p">&lt;</span><span class="n">SensorValue</span><span class="p">&gt;</span> <span class="n">_data</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="p">...</span>

  <span class="nd">@override</span>
  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Scaffold</span><span class="p">(</span>
      <span class="nl">backgroundColor:</span> <span class="n">Colors</span><span class="o">.</span><span class="na">white</span><span class="p">,</span>
      <span class="nl">body:</span> <span class="n">SafeArea</span><span class="p">(</span>
        <span class="nl">child:</span> <span class="n">Column</span><span class="p">(</span>
          <span class="nl">children:</span> <span class="p">&lt;</span><span class="n">Widget</span><span class="p">&gt;[</span>
            <span class="n">Expanded</span><span class="p">(</span>
              <span class="nl">child:</span> <span class="n">Container</span><span class="p">(</span>
                <span class="nl">color:</span> <span class="n">Colors</span><span class="o">.</span><span class="na">red</span><span class="p">,</span>
              <span class="p">),</span>
            <span class="p">),</span>
            <span class="n">Expanded</span><span class="p">(</span>
              <span class="nl">child:</span> <span class="n">Center</span><span class="p">(</span>
                <span class="nl">child:</span> <span class="n">IconButton</span><span class="p">(</span>
                  <span class="nl">icon:</span> <span class="n">Icon</span><span class="p">(</span><span class="n">_toggled</span> <span class="o">?</span> <span class="n">Icons</span><span class="o">.</span><span class="na">favorite</span> <span class="o">:</span> <span class="n">Icons</span><span class="o">.</span><span class="na">favorite_border</span><span class="p">),</span>
                  <span class="nl">color:</span> <span class="n">Colors</span><span class="o">.</span><span class="na">red</span><span class="p">,</span>
                  <span class="nl">iconSize:</span> <span class="mi">128</span><span class="p">,</span>
                  <span class="nl">onPressed:</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">_toggled</span><span class="p">)</span> <span class="p">{</span>
                      <span class="n">_untoggle</span><span class="p">();</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                      <span class="n">_toggle</span><span class="p">();</span>
                    <span class="p">}</span>
                  <span class="p">},</span>
                <span class="p">),</span>
              <span class="p">),</span>
            <span class="p">),</span>
            <span class="n">Expanded</span><span class="p">(</span>
              <span class="nl">child:</span> <span class="n">Container</span><span class="p">(</span>
                <span class="nl">margin:</span> <span class="n">EdgeInsets</span><span class="o">.</span><span class="na">all</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span>
                <span class="nl">decoration:</span> <span class="n">BoxDecoration</span><span class="p">(</span>
                    <span class="nl">borderRadius:</span> <span class="n">BorderRadius</span><span class="o">.</span><span class="na">all</span><span class="p">(</span>
                      <span class="n">Radius</span><span class="o">.</span><span class="na">circular</span><span class="p">(</span><span class="mi">18</span><span class="p">),</span>
                    <span class="p">),</span>
                    <span class="nl">color:</span> <span class="n">Colors</span><span class="o">.</span><span class="na">black</span><span class="p">),</span>
                <span class="nl">child:</span> <span class="n">Chart</span><span class="p">(</span><span class="n">_data</span><span class="p">),</span>
              <span class="p">),</span>
            <span class="p">),</span>
          <span class="p">],</span>
        <span class="p">),</span>
      <span class="p">),</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<div class="row mt-3">
    <div class="col-sm mt-3 pt-md-0 pl-xl-5 pr-xl-5">
    <div class="col-sm mt-3 pt-md-0 pl-xl-5 pr-xl-5">
    <div class="col-sm mt-3 pt-md-0 pl-xl-5 pr-xl-5">
    <div class="col-sm mt-3 pt-md-0 pl-xl-5 pr-xl-5">
        <img class="img-fluid rounded z-depth-1" src="/assets/img/posts/2020-04-08-ppg/chart.png" />
    </div>
    </div>
    </div>
    </div>
</div>
<div class="caption">
Screenshot of the chart container.
</div>

<p>For the chart widget, we will use the package <code class="language-plaintext highlighter-rouge">charts_flutter</code>. The file <code class="language-plaintext highlighter-rouge">chart.dart</code> contains a <code class="language-plaintext highlighter-rouge">StatelessWidget</code> that displays in a chart points provided in a list. Each point is constituted by a <code class="language-plaintext highlighter-rouge">DateTime</code> value, which indicates the <code class="language-plaintext highlighter-rouge">x</code> value, and a <code class="language-plaintext highlighter-rouge">double</code> value that represents the <code class="language-plaintext highlighter-rouge">y</code> value.</p>

<figure class="highlight"><pre><code class="language-dart" data-lang="dart"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="s">'package:charts_flutter/flutter.dart'</span> <span class="k">as</span> <span class="n">charts</span><span class="o">;</span>
<span class="kn">import</span> <span class="s">'package:flutter/material.dart'</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">Chart</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="p">{</span>
  <span class="kd">final</span> <span class="kt">List</span><span class="p">&lt;</span><span class="n">SensorValue</span><span class="p">&gt;</span> <span class="n">_data</span><span class="p">;</span>

  <span class="n">Chart</span><span class="p">(</span><span class="k">this</span><span class="o">.</span><span class="na">_data</span><span class="p">);</span>

  <span class="nd">@override</span>
  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">charts</span><span class="o">.</span><span class="na">TimeSeriesChart</span><span class="p">([</span>
      <span class="n">charts</span><span class="o">.</span><span class="na">Series</span><span class="p">&lt;</span><span class="n">SensorValue</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">&gt;(</span>
        <span class="nl">id:</span> <span class="s">'Values'</span><span class="p">,</span>
        <span class="nl">colorFn:</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">)</span> <span class="o">=</span><span class="p">&gt;</span> <span class="n">charts</span><span class="o">.</span><span class="na">MaterialPalette</span><span class="o">.</span><span class="na">green</span><span class="o">.</span><span class="na">shadeDefault</span><span class="p">,</span>
        <span class="nl">domainFn:</span> <span class="p">(</span><span class="n">SensorValue</span> <span class="n">values</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span><span class="p">&gt;</span> <span class="n">values</span><span class="o">.</span><span class="na">time</span><span class="p">,</span>
        <span class="nl">measureFn:</span> <span class="p">(</span><span class="n">SensorValue</span> <span class="n">values</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span><span class="p">&gt;</span> <span class="n">values</span><span class="o">.</span><span class="na">value</span><span class="p">,</span>
        <span class="nl">data:</span> <span class="n">_data</span><span class="p">,</span>
      <span class="p">)</span>
    <span class="p">],</span>
        <span class="nl">animate:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nl">primaryMeasureAxis:</span> <span class="n">charts</span><span class="o">.</span><span class="na">NumericAxisSpec</span><span class="p">(</span>
          <span class="nl">tickProviderSpec:</span>
              <span class="n">charts</span><span class="o">.</span><span class="na">BasicNumericTickProviderSpec</span><span class="p">(</span><span class="nl">zeroBound:</span> <span class="kc">false</span><span class="p">),</span>
          <span class="nl">renderSpec:</span> <span class="n">charts</span><span class="o">.</span><span class="na">NoneRenderSpec</span><span class="p">(),</span>
        <span class="p">),</span>
        <span class="nl">domainAxis:</span> <span class="k">new</span> <span class="n">charts</span><span class="o">.</span><span class="na">DateTimeAxisSpec</span><span class="p">(</span>
            <span class="nl">renderSpec:</span> <span class="k">new</span> <span class="n">charts</span><span class="o">.</span><span class="na">NoneRenderSpec</span><span class="p">()));</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">SensorValue</span> <span class="p">{</span>
  <span class="kd">final</span> <span class="n">DateTime</span> <span class="n">time</span><span class="p">;</span>
  <span class="kd">final</span> <span class="kt">double</span> <span class="n">value</span><span class="p">;</span>

  <span class="n">SensorValue</span><span class="p">(</span><span class="k">this</span><span class="o">.</span><span class="na">time</span><span class="p">,</span> <span class="k">this</span><span class="o">.</span><span class="na">value</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Regarding the upper <code class="language-plaintext highlighter-rouge">Container</code>, we wish to divide it into two halves. On the left one, will display the <code class="language-plaintext highlighter-rouge">CameraPreview</code> and, on the right half a <code class="language-plaintext highlighter-rouge">Text</code> containing the Beats Per Minute (BPM).</p>

<figure class="highlight"><pre><code class="language-dart" data-lang="dart"><span class="kd">class</span> <span class="nc">HomePageView</span> <span class="kd">extends</span> <span class="n">State</span><span class="p">&lt;</span><span class="n">HomePage</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="kt">bool</span> <span class="n">_toggled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="kt">List</span><span class="p">&lt;</span><span class="n">SensorValue</span><span class="p">&gt;</span> <span class="n">_data</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="n">CameraController</span> <span class="n">_controller</span><span class="p">;</span>

  <span class="p">...</span>

  <span class="nd">@override</span>
  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Scaffold</span><span class="p">(</span>
      <span class="nl">backgroundColor:</span> <span class="n">Colors</span><span class="o">.</span><span class="na">white</span><span class="p">,</span>
      <span class="nl">body:</span> <span class="n">SafeArea</span><span class="p">(</span>
        <span class="nl">child:</span> <span class="n">Column</span><span class="p">(</span>
          <span class="nl">children:</span> <span class="p">&lt;</span><span class="n">Widget</span><span class="p">&gt;[</span>
            <span class="n">Expanded</span><span class="p">(</span>
              <span class="nl">child:</span> <span class="n">Row</span><span class="p">(</span>
                <span class="nl">children:</span> <span class="p">&lt;</span><span class="n">Widget</span><span class="p">&gt;[</span>
                  <span class="n">Expanded</span><span class="p">(</span>
                    <span class="nl">child:</span> <span class="n">Center</span><span class="p">(</span>
                      <span class="nl">child:</span> <span class="n">_controller</span> <span class="o">==</span> <span class="kc">null</span>
                          <span class="o">?</span> <span class="n">Container</span><span class="p">()</span>
                          <span class="o">:</span> <span class="n">CameraPreview</span><span class="p">(</span><span class="n">_controller</span><span class="p">),</span>
                    <span class="p">),</span>
                  <span class="p">),</span>
                  <span class="n">Expanded</span><span class="p">(</span>
                    <span class="nl">child:</span> <span class="n">Center</span><span class="p">(</span>
                      <span class="nl">child:</span> <span class="n">Text</span><span class="p">(</span><span class="s">"BPM"</span><span class="p">),</span>
                    <span class="p">),</span>
                  <span class="p">),</span>
                <span class="p">],</span>
              <span class="p">),</span>
            <span class="p">),</span>
            <span class="n">Expanded</span><span class="p">(</span>
              <span class="nl">child:</span> <span class="n">Center</span><span class="p">(</span>
                <span class="nl">child:</span> <span class="n">IconButton</span><span class="p">(</span>
                  <span class="nl">icon:</span> <span class="n">Icon</span><span class="p">(</span><span class="n">_toggled</span> <span class="o">?</span> <span class="n">Icons</span><span class="o">.</span><span class="na">favorite</span> <span class="o">:</span> <span class="n">Icons</span><span class="o">.</span><span class="na">favorite_border</span><span class="p">),</span>
                  <span class="nl">color:</span> <span class="n">Colors</span><span class="o">.</span><span class="na">red</span><span class="p">,</span>
                  <span class="nl">iconSize:</span> <span class="mi">128</span><span class="p">,</span>
                  <span class="nl">onPressed:</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">_toggled</span><span class="p">)</span> <span class="p">{</span>
                      <span class="n">_untoggle</span><span class="p">();</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                      <span class="n">_toggle</span><span class="p">();</span>
                    <span class="p">}</span>
                  <span class="p">},</span>
                <span class="p">),</span>
              <span class="p">),</span>
            <span class="p">),</span>
            <span class="n">Expanded</span><span class="p">(</span>
              <span class="nl">child:</span> <span class="n">Container</span><span class="p">(</span>
                <span class="nl">margin:</span> <span class="n">EdgeInsets</span><span class="o">.</span><span class="na">all</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span>
                <span class="nl">decoration:</span> <span class="n">BoxDecoration</span><span class="p">(</span>
                    <span class="nl">borderRadius:</span> <span class="n">BorderRadius</span><span class="o">.</span><span class="na">all</span><span class="p">(</span>
                      <span class="n">Radius</span><span class="o">.</span><span class="na">circular</span><span class="p">(</span><span class="mi">18</span><span class="p">),</span>
                    <span class="p">),</span>
                    <span class="nl">color:</span> <span class="n">Colors</span><span class="o">.</span><span class="na">black</span><span class="p">),</span>
                <span class="nl">child:</span> <span class="n">Chart</span><span class="p">(</span><span class="n">_data</span><span class="p">),</span>
              <span class="p">),</span>
            <span class="p">),</span>
          <span class="p">],</span>
        <span class="p">),</span>
      <span class="p">),</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<div class="row mt-3">
    <div class="col-sm mt-3 pt-md-0 pl-xl-5 pr-xl-5">
    <div class="col-sm mt-3 pt-md-0 pl-xl-5 pr-xl-5">
    <div class="col-sm mt-3 pt-md-0 pl-xl-5 pr-xl-5">
    <div class="col-sm mt-3 pt-md-0 pl-xl-5 pr-xl-5">
        <img class="img-fluid rounded z-depth-1" src="/assets/img/posts/2020-04-08-ppg/layout.png" />
    </div>
    </div>
    </div>
    </div>
</div>

<p>The <code class="language-plaintext highlighter-rouge">CameraPreview</code> widget requires a valid <code class="language-plaintext highlighter-rouge">CameraController</code>. So we need to initialize the controller once we press the heart button and it‚Äôs toggled. Once the button is untoggled, we must also dispose of the controller:</p>

<figure class="highlight"><pre><code class="language-dart" data-lang="dart"><span class="n">Future</span><span class="p">&lt;</span><span class="kt">void</span><span class="p">&gt;</span> <span class="n">_initController</span><span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kt">List</span> <span class="n">_cameras</span> <span class="o">=</span> <span class="k">await</span> <span class="n">availableCameras</span><span class="p">();</span>
    <span class="n">_controller</span> <span class="o">=</span> <span class="n">CameraController</span><span class="p">(</span><span class="n">_cameras</span><span class="o">.</span><span class="na">first</span><span class="p">,</span> <span class="n">ResolutionPreset</span><span class="o">.</span><span class="na">low</span><span class="p">);</span>
    <span class="k">await</span> <span class="n">_controller</span><span class="o">.</span><span class="na">initialize</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">print</span><span class="p">(</span><span class="n">Exception</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">_disposeController</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">_controller</span><span class="o">.</span><span class="na">dispose</span><span class="p">();</span>
  <span class="n">_controller</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Now, we only need to integrate these functions in the functions that toggle the button.</p>

<figure class="highlight"><pre><code class="language-dart" data-lang="dart"><span class="n">_toggle</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">_initController</span><span class="p">()</span><span class="o">.</span><span class="na">then</span><span class="p">((</span><span class="n">onValue</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
      <span class="n">_toggled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="n">_untoggle</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">_disposeController</span><span class="p">();</span>
  <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
    <span class="n">_toggled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">}</span></code></pre></figure>

<p>We should also override the dispose method and dispose of the <code class="language-plaintext highlighter-rouge">CameraController</code> once the application is disposed.</p>

<figure class="highlight"><pre><code class="language-dart" data-lang="dart"><span class="nd">@override</span>
<span class="kt">void</span> <span class="nf">dispose</span><span class="p">()</span> <span class="p">{</span> 
  <span class="n">_disposeController</span><span class="p">();</span>
  <span class="k">super</span><span class="o">.</span><span class="na">dispose</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<p>We must not forget to activate the camera‚Äôs flash and then start the <code class="language-plaintext highlighter-rouge">ImageStream</code>, which will provide the images that we will process. The function <code class="language-plaintext highlighter-rouge">_scanImage</code> will take care of it.</p>

<figure class="highlight"><pre><code class="language-dart" data-lang="dart"><span class="n">Future</span><span class="p">&lt;</span><span class="kt">void</span><span class="p">&gt;</span> <span class="n">_initController</span><span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kt">List</span> <span class="n">_cameras</span> <span class="o">=</span> <span class="k">await</span> <span class="n">availableCameras</span><span class="p">();</span>
    <span class="n">_controller</span> <span class="o">=</span> <span class="n">CameraController</span><span class="p">(</span><span class="n">_cameras</span><span class="o">.</span><span class="na">first</span><span class="p">,</span> <span class="n">ResolutionPreset</span><span class="o">.</span><span class="na">low</span><span class="p">);</span>
    <span class="k">await</span> <span class="n">_controller</span><span class="o">.</span><span class="na">initialize</span><span class="p">();</span>
    <span class="n">Future</span><span class="o">.</span><span class="na">delayed</span><span class="p">(</span><span class="n">Duration</span><span class="p">(</span><span class="nl">milliseconds:</span> <span class="mi">100</span><span class="p">))</span><span class="o">.</span><span class="na">then</span><span class="p">((</span><span class="n">onValue</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_controller</span><span class="o">.</span><span class="na">setFlashMode</span><span class="p">(</span><span class="n">FlashMode</span><span class="o">.</span><span class="na">torch</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="n">_controller</span><span class="o">.</span><span class="na">startImageStream</span><span class="p">((</span><span class="n">CameraImage</span> <span class="n">image</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">_scanImage</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">print</span><span class="p">(</span><span class="n">Exception</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The function <code class="language-plaintext highlighter-rouge">_scanImage</code> calculates the average of the camera image‚Äôs red channel and adds the value to the data list, which is displayed on the chart explained above. Notice that we limit the number of points of the data list to 50 values.</p>

<figure class="highlight"><pre><code class="language-dart" data-lang="dart"><span class="n">_scanImage</span><span class="p">(</span><span class="n">CameraImage</span> <span class="n">image</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">_avg</span> <span class="o">=</span>
      <span class="n">image</span><span class="o">.</span><span class="na">planes</span><span class="o">.</span><span class="na">first</span><span class="o">.</span><span class="na">bytes</span><span class="o">.</span><span class="na">reduce</span><span class="p">((</span><span class="n">value</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span> <span class="o">=</span><span class="p">&gt;</span> <span class="n">value</span> <span class="o">+</span> <span class="n">element</span><span class="p">)</span> <span class="o">/</span>
          <span class="n">image</span><span class="o">.</span><span class="na">planes</span><span class="o">.</span><span class="na">first</span><span class="o">.</span><span class="na">bytes</span><span class="o">.</span><span class="na">length</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">_data</span><span class="o">.</span><span class="na">length</span> <span class="p">&gt;</span><span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">_data</span><span class="o">.</span><span class="na">removeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
    <span class="n">_data</span><span class="o">.</span><span class="na">add</span><span class="p">(</span><span class="n">SensorValue</span><span class="p">(</span><span class="n">DateTime</span><span class="o">.</span><span class="na">now</span><span class="p">(),</span> <span class="n">_avg</span><span class="p">));</span>
  <span class="p">});</span>
<span class="p">}</span></code></pre></figure>

<p>We do not need to process every frame, therefore, we can select a sampling rate. In this example, a sampling rate of 30 samples/seconds is used. For that purpose, we have a boolean, <code class="language-plaintext highlighter-rouge">_processing</code>, which becomes <code class="language-plaintext highlighter-rouge">true</code> once the <code class="language-plaintext highlighter-rouge">_scanImage</code> function is called and stays that way for 1/30 seconds, then returns to false. The <code class="language-plaintext highlighter-rouge">_scanImage</code> function will only be executed if the boolean _processing is false.</p>

<figure class="highlight"><pre><code class="language-dart" data-lang="dart"><span class="n">Future</span><span class="p">&lt;</span><span class="kt">void</span><span class="p">&gt;</span> <span class="n">_initController</span><span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kt">List</span> <span class="n">_cameras</span> <span class="o">=</span> <span class="k">await</span> <span class="n">availableCameras</span><span class="p">();</span>
    <span class="n">_controller</span> <span class="o">=</span> <span class="n">CameraController</span><span class="p">(</span><span class="n">_cameras</span><span class="o">.</span><span class="na">first</span><span class="p">,</span> <span class="n">ResolutionPreset</span><span class="o">.</span><span class="na">low</span><span class="p">);</span>
    <span class="k">await</span> <span class="n">_controller</span><span class="o">.</span><span class="na">initialize</span><span class="p">();</span>
    <span class="n">Future</span><span class="o">.</span><span class="na">delayed</span><span class="p">(</span><span class="n">Duration</span><span class="p">(</span><span class="nl">milliseconds:</span> <span class="mi">100</span><span class="p">))</span><span class="o">.</span><span class="na">then</span><span class="p">((</span><span class="n">onValue</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_controller</span><span class="o">.</span><span class="na">setFlashMode</span><span class="p">(</span><span class="n">FlashMode</span><span class="o">.</span><span class="na">torch</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="n">_controller</span><span class="o">.</span><span class="na">startImageStream</span><span class="p">((</span><span class="n">CameraImage</span> <span class="n">image</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_processing</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
          <span class="n">_processing</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">});</span>
        <span class="n">_scanImage</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">print</span><span class="p">(</span><span class="n">Exception</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">_scanImage</span><span class="p">(</span><span class="n">CameraImage</span> <span class="n">image</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">_avg</span> <span class="o">=</span>
      <span class="n">image</span><span class="o">.</span><span class="na">planes</span><span class="o">.</span><span class="na">first</span><span class="o">.</span><span class="na">bytes</span><span class="o">.</span><span class="na">reduce</span><span class="p">((</span><span class="n">value</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span> <span class="o">=</span><span class="p">&gt;</span> <span class="n">value</span> <span class="o">+</span> <span class="n">element</span><span class="p">)</span> <span class="o">/</span>
          <span class="n">image</span><span class="o">.</span><span class="na">planes</span><span class="o">.</span><span class="na">first</span><span class="o">.</span><span class="na">bytes</span><span class="o">.</span><span class="na">length</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">_data</span><span class="o">.</span><span class="na">length</span> <span class="p">&gt;</span><span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">_data</span><span class="o">.</span><span class="na">removeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
    <span class="n">_data</span><span class="o">.</span><span class="na">add</span><span class="p">(</span><span class="n">SensorValue</span><span class="p">(</span><span class="n">DateTime</span><span class="o">.</span><span class="na">now</span><span class="p">(),</span> <span class="n">_avg</span><span class="p">));</span>
  <span class="p">});</span>
  <span class="n">Future</span><span class="o">.</span><span class="na">delayed</span><span class="p">(</span><span class="n">Duration</span><span class="p">(</span><span class="nl">milliseconds:</span> <span class="mi">1000</span> <span class="o">~/</span> <span class="mi">30</span><span class="p">))</span><span class="o">.</span><span class="na">then</span><span class="p">((</span><span class="n">onValue</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
      <span class="n">_processing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span></code></pre></figure>

<p>For good practice, we should also set the <code class="language-plaintext highlighter-rouge">_processing</code> value to false every time we change the heart button‚Äôs toggled state.</p>

<figure class="highlight"><pre><code class="language-dart" data-lang="dart"><span class="n">_toggle</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">_initController</span><span class="p">()</span><span class="o">.</span><span class="na">then</span><span class="p">((</span><span class="n">onValue</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
      <span class="n">_toggled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="n">_processing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="n">_untoggle</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">_disposeController</span><span class="p">();</span>
  <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
    <span class="n">_toggled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="n">_processing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">}</span></code></pre></figure>

<p>We now have an application that measures the blood flow volume variability and displays it in a chart. Now we only need to calculate the heart rate, which is the frequency of the plotted signal. I used a simple algorithm that measures the average and the max along our window data, sets the threshold to the mean of those values, and detects the peaks above that threshold. It then updates the BPM value with an attenuation coefficient so we don‚Äôt have abrupt changes.</p>

<figure class="highlight"><pre><code class="language-dart" data-lang="dart"><span class="kd">class</span> <span class="nc">HomePageView</span> <span class="kd">extends</span> <span class="n">State</span><span class="p">&lt;</span><span class="n">HomePage</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="p">...</span>
    
  <span class="kt">double</span> <span class="n">_alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">;</span>

  <span class="n">_toggle</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">_initController</span><span class="p">()</span><span class="o">.</span><span class="na">then</span><span class="p">((</span><span class="n">onValue</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
        <span class="n">_toggled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="n">_processing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">});</span>
      <span class="n">_updateBPM</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">}</span>
  
  <span class="p">...</span>

  <span class="n">_updateBPM</span><span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
    <span class="kt">List</span><span class="p">&lt;</span><span class="n">SensorValue</span><span class="p">&gt;</span> <span class="n">_values</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">_avg</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">_n</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">_m</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">_threshold</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">_bpm</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">_counter</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">_previous</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">_toggled</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">_values</span> <span class="o">=</span> <span class="kt">List</span><span class="o">.</span><span class="na">from</span><span class="p">(</span><span class="n">_data</span><span class="p">);</span>
      <span class="n">_avg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">_n</span> <span class="o">=</span> <span class="n">_values</span><span class="o">.</span><span class="na">length</span><span class="p">;</span>
      <span class="n">_m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">_values</span><span class="o">.</span><span class="na">forEach</span><span class="p">((</span><span class="n">SensorValue</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_avg</span> <span class="o">+=</span> <span class="n">value</span><span class="o">.</span><span class="na">value</span> <span class="o">/</span> <span class="n">_n</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="na">value</span> <span class="p">&gt;</span> <span class="n">_m</span><span class="p">)</span> <span class="n">_m</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">value</span><span class="p">;</span>
      <span class="p">});</span>
      <span class="n">_threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">_m</span> <span class="o">+</span> <span class="n">_avg</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
      <span class="n">_bpm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">_previous</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">_n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_values</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="na">value</span> <span class="p">&lt;</span> <span class="n">_threshold</span> <span class="o">&amp;&amp;</span>
            <span class="n">_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="na">value</span> <span class="p">&gt;</span> <span class="n">_threshold</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">_previous</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">_counter</span><span class="o">++</span><span class="p">;</span>
            <span class="n">_bpm</span> <span class="o">+=</span>
                <span class="mi">60000</span> <span class="o">/</span> <span class="p">(</span><span class="n">_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="na">time</span><span class="o">.</span><span class="na">millisecondsSinceEpoch</span> <span class="o">-</span> <span class="n">_previous</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="n">_previous</span> <span class="o">=</span> <span class="n">_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="na">time</span><span class="o">.</span><span class="na">millisecondsSinceEpoch</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">_counter</span> <span class="p">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_bpm</span> <span class="o">=</span> <span class="n">_bpm</span> <span class="o">/</span> <span class="n">_counter</span><span class="p">;</span>
        <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
          <span class="n">_bpm</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">_alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">_bpm</span> <span class="o">+</span> <span class="n">_alpha</span> <span class="o">*</span> <span class="n">_bpm</span><span class="p">;</span>
        <span class="p">});</span>
      <span class="p">}</span>
      <span class="k">await</span> <span class="n">Future</span><span class="o">.</span><span class="na">delayed</span><span class="p">(</span><span class="n">Duration</span><span class="p">(</span><span class="nl">milliseconds:</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">50</span> <span class="o">/</span> <span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="na">round</span><span class="p">()));</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="p">...</span>
    
<span class="p">}</span></code></pre></figure>

<p>The last thing we need to do is avoid the screen from turning off while the :</p>

<figure class="highlight"><pre><code class="language-dart" data-lang="dart"><span class="n">_toggle</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">_initController</span><span class="p">()</span><span class="o">.</span><span class="na">then</span><span class="p">((</span><span class="n">onValue</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Wakelock</span><span class="o">.</span><span class="na">enable</span><span class="p">();</span>
    <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
      <span class="n">_toggled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="n">_processing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="n">_updateBPM</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="n">_untoggle</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">_disposeController</span><span class="p">();</span>
  <span class="n">Wakelock</span><span class="o">.</span><span class="na">disable</span><span class="p">();</span>
  <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
    <span class="n">_toggled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="n">_processing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">}</span></code></pre></figure>

<p>At last, we have an application that measures the blood volume variability and estimates the BPM.</p>

<p>The full code:</p>

<figure class="highlight"><pre><code class="language-dart" data-lang="dart"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="s">'package:camera/camera.dart'</span><span class="o">;</span>
<span class="kn">import</span> <span class="s">'package:flutter/material.dart'</span><span class="o">;</span>
<span class="kn">import</span> <span class="s">'package:wakelock/wakelock.dart'</span><span class="o">;</span>
<span class="kn">import</span> <span class="s">'chart.dart'</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">HomePage</span> <span class="kd">extends</span> <span class="n">StatefulWidget</span> <span class="p">{</span>
  <span class="nd">@override</span>
  <span class="n">HomePageView</span> <span class="n">createState</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">HomePageView</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">HomePageView</span> <span class="kd">extends</span> <span class="n">State</span><span class="p">&lt;</span><span class="n">HomePage</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="kt">bool</span> <span class="n">_toggled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">_processing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="kt">List</span><span class="p">&lt;</span><span class="n">SensorValue</span><span class="p">&gt;</span> <span class="n">_data</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="n">CameraController</span> <span class="n">_controller</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">_alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">_bpm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">_toggle</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">_initController</span><span class="p">()</span><span class="o">.</span><span class="na">then</span><span class="p">((</span><span class="n">onValue</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">Wakelock</span><span class="o">.</span><span class="na">enable</span><span class="p">();</span>
      <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
        <span class="n">_toggled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="n">_processing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">});</span>
      <span class="n">_updateBPM</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="n">_untoggle</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">_disposeController</span><span class="p">();</span>
    <span class="n">Wakelock</span><span class="o">.</span><span class="na">disable</span><span class="p">();</span>
    <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
      <span class="n">_toggled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="n">_processing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="n">Future</span><span class="p">&lt;</span><span class="kt">void</span><span class="p">&gt;</span> <span class="n">_initController</span><span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kt">List</span> <span class="n">_cameras</span> <span class="o">=</span> <span class="k">await</span> <span class="n">availableCameras</span><span class="p">();</span>
      <span class="n">_controller</span> <span class="o">=</span> <span class="n">CameraController</span><span class="p">(</span><span class="n">_cameras</span><span class="o">.</span><span class="na">first</span><span class="p">,</span> <span class="n">ResolutionPreset</span><span class="o">.</span><span class="na">low</span><span class="p">);</span>
      <span class="k">await</span> <span class="n">_controller</span><span class="o">.</span><span class="na">initialize</span><span class="p">();</span>
      <span class="n">Future</span><span class="o">.</span><span class="na">delayed</span><span class="p">(</span><span class="n">Duration</span><span class="p">(</span><span class="nl">milliseconds:</span> <span class="mi">100</span><span class="p">))</span><span class="o">.</span><span class="na">then</span><span class="p">((</span><span class="n">onValue</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_controller</span><span class="o">.</span><span class="na">setFlashMode</span><span class="p">(</span><span class="n">FlashMode</span><span class="o">.</span><span class="na">torch</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="n">_controller</span><span class="o">.</span><span class="na">startImageStream</span><span class="p">((</span><span class="n">CameraImage</span> <span class="n">image</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_processing</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
            <span class="n">_processing</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="p">});</span>
          <span class="n">_scanImage</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">print</span><span class="p">(</span><span class="n">Exception</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">_updateBPM</span><span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
    <span class="kt">List</span><span class="p">&lt;</span><span class="n">SensorValue</span><span class="p">&gt;</span> <span class="n">_values</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">_avg</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">_n</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">_m</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">_threshold</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">_bpm</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">_counter</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">_previous</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">_toggled</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">_values</span> <span class="o">=</span> <span class="kt">List</span><span class="o">.</span><span class="na">from</span><span class="p">(</span><span class="n">_data</span><span class="p">);</span>
      <span class="n">_avg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">_n</span> <span class="o">=</span> <span class="n">_values</span><span class="o">.</span><span class="na">length</span><span class="p">;</span>
      <span class="n">_m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">_values</span><span class="o">.</span><span class="na">forEach</span><span class="p">((</span><span class="n">SensorValue</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_avg</span> <span class="o">+=</span> <span class="n">value</span><span class="o">.</span><span class="na">value</span> <span class="o">/</span> <span class="n">_n</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="na">value</span> <span class="p">&gt;</span> <span class="n">_m</span><span class="p">)</span> <span class="n">_m</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">value</span><span class="p">;</span>
      <span class="p">});</span>
      <span class="n">_threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">_m</span> <span class="o">+</span> <span class="n">_avg</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
      <span class="n">_bpm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">_previous</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">_n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_values</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="na">value</span> <span class="p">&lt;</span> <span class="n">_threshold</span> <span class="o">&amp;&amp;</span>
            <span class="n">_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="na">value</span> <span class="p">&gt;</span> <span class="n">_threshold</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">_previous</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">_counter</span><span class="o">++</span><span class="p">;</span>
            <span class="n">_bpm</span> <span class="o">+=</span>
                <span class="mi">60000</span> <span class="o">/</span> <span class="p">(</span><span class="n">_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="na">time</span><span class="o">.</span><span class="na">millisecondsSinceEpoch</span> <span class="o">-</span> <span class="n">_previous</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="n">_previous</span> <span class="o">=</span> <span class="n">_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="na">time</span><span class="o">.</span><span class="na">millisecondsSinceEpoch</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">_counter</span> <span class="p">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_bpm</span> <span class="o">=</span> <span class="n">_bpm</span> <span class="o">/</span> <span class="n">_counter</span><span class="p">;</span>
        <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
          <span class="n">_bpm</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">_alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">_bpm</span> <span class="o">+</span> <span class="n">_alpha</span> <span class="o">*</span> <span class="n">_bpm</span><span class="p">;</span>
        <span class="p">});</span>
      <span class="p">}</span>
      <span class="k">await</span> <span class="n">Future</span><span class="o">.</span><span class="na">delayed</span><span class="p">(</span><span class="n">Duration</span><span class="p">(</span><span class="nl">milliseconds:</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">50</span> <span class="o">/</span> <span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="na">round</span><span class="p">()));</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">_scanImage</span><span class="p">(</span><span class="n">CameraImage</span> <span class="n">image</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">_avg</span> <span class="o">=</span>
        <span class="n">image</span><span class="o">.</span><span class="na">planes</span><span class="o">.</span><span class="na">first</span><span class="o">.</span><span class="na">bytes</span><span class="o">.</span><span class="na">reduce</span><span class="p">((</span><span class="n">value</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span> <span class="o">=</span><span class="p">&gt;</span> <span class="n">value</span> <span class="o">+</span> <span class="n">element</span><span class="p">)</span> <span class="o">/</span>
            <span class="n">image</span><span class="o">.</span><span class="na">planes</span><span class="o">.</span><span class="na">first</span><span class="o">.</span><span class="na">bytes</span><span class="o">.</span><span class="na">length</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_data</span><span class="o">.</span><span class="na">length</span> <span class="p">&gt;</span><span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">_data</span><span class="o">.</span><span class="na">removeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
      <span class="n">_data</span><span class="o">.</span><span class="na">add</span><span class="p">(</span><span class="n">SensorValue</span><span class="p">(</span><span class="n">DateTime</span><span class="o">.</span><span class="na">now</span><span class="p">(),</span> <span class="n">_avg</span><span class="p">));</span>
    <span class="p">});</span>
    <span class="n">Future</span><span class="o">.</span><span class="na">delayed</span><span class="p">(</span><span class="n">Duration</span><span class="p">(</span><span class="nl">milliseconds:</span> <span class="mi">1000</span> <span class="o">~/</span> <span class="mi">30</span><span class="p">))</span><span class="o">.</span><span class="na">then</span><span class="p">((</span><span class="n">onValue</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
        <span class="n">_processing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="n">_disposeController</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">_controller</span><span class="o">.</span><span class="na">dispose</span><span class="p">();</span>
    <span class="n">_controller</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nd">@override</span>
  <span class="kt">void</span> <span class="n">dispose</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">_disposeController</span><span class="p">();</span>
    <span class="k">super</span><span class="o">.</span><span class="na">dispose</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nd">@override</span>
  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Scaffold</span><span class="p">(</span>
      <span class="nl">backgroundColor:</span> <span class="n">Colors</span><span class="o">.</span><span class="na">white</span><span class="p">,</span>
      <span class="nl">body:</span> <span class="n">SafeArea</span><span class="p">(</span>
        <span class="nl">child:</span> <span class="n">Column</span><span class="p">(</span>
          <span class="nl">children:</span> <span class="p">&lt;</span><span class="n">Widget</span><span class="p">&gt;[</span>
            <span class="n">Expanded</span><span class="p">(</span>
              <span class="nl">child:</span> <span class="n">Row</span><span class="p">(</span>
                <span class="nl">children:</span> <span class="p">&lt;</span><span class="n">Widget</span><span class="p">&gt;[</span>
                  <span class="n">Expanded</span><span class="p">(</span>
                    <span class="nl">child:</span> <span class="n">Center</span><span class="p">(</span>
                      <span class="nl">child:</span> <span class="n">_controller</span> <span class="o">==</span> <span class="kc">null</span>
                          <span class="o">?</span> <span class="n">Container</span><span class="p">()</span>
                          <span class="o">:</span> <span class="n">CameraPreview</span><span class="p">(</span><span class="n">_controller</span><span class="p">),</span>
                    <span class="p">),</span>
                  <span class="p">),</span>
                  <span class="n">Expanded</span><span class="p">(</span>
                    <span class="nl">child:</span> <span class="n">Center</span><span class="p">(</span>
                      <span class="nl">child:</span> <span class="n">Text</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">_bpm</span> <span class="p">&gt;</span> <span class="mi">30</span> <span class="o">&amp;&amp;</span> <span class="n">_bpm</span> <span class="p">&lt;</span> <span class="mi">150</span> <span class="o">?</span> <span class="n">_bpm</span><span class="o">.</span><span class="na">round</span><span class="p">()</span><span class="o">.</span><span class="na">toString</span><span class="p">()</span> <span class="o">:</span> <span class="s">"--"</span><span class="p">),</span>
                        <span class="nl">style:</span> <span class="n">TextStyle</span><span class="p">(</span><span class="nl">fontSize:</span> <span class="mi">32</span><span class="p">,</span> <span class="nl">fontWeight:</span> <span class="n">FontWeight</span><span class="o">.</span><span class="na">bold</span><span class="p">),</span>
                      <span class="p">),</span>
                    <span class="p">),</span>
                  <span class="p">),</span>
                <span class="p">],</span>
              <span class="p">),</span>
            <span class="p">),</span>
            <span class="n">Expanded</span><span class="p">(</span>
              <span class="nl">child:</span> <span class="n">Center</span><span class="p">(</span>
                <span class="nl">child:</span> <span class="n">IconButton</span><span class="p">(</span>
                  <span class="nl">icon:</span> <span class="n">Icon</span><span class="p">(</span><span class="n">_toggled</span> <span class="o">?</span> <span class="n">Icons</span><span class="o">.</span><span class="na">favorite</span> <span class="o">:</span> <span class="n">Icons</span><span class="o">.</span><span class="na">favorite_border</span><span class="p">),</span>
                  <span class="nl">color:</span> <span class="n">Colors</span><span class="o">.</span><span class="na">red</span><span class="p">,</span>
                  <span class="nl">iconSize:</span> <span class="mi">128</span><span class="p">,</span>
                  <span class="nl">onPressed:</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">_toggled</span><span class="p">)</span> <span class="p">{</span>
                      <span class="n">_untoggle</span><span class="p">();</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                      <span class="n">_toggle</span><span class="p">();</span>
                    <span class="p">}</span>
                  <span class="p">},</span>
                <span class="p">),</span>
              <span class="p">),</span>
            <span class="p">),</span>
            <span class="n">Expanded</span><span class="p">(</span>
              <span class="nl">child:</span> <span class="n">Container</span><span class="p">(</span>
                <span class="nl">margin:</span> <span class="n">EdgeInsets</span><span class="o">.</span><span class="na">all</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span>
                <span class="nl">decoration:</span> <span class="n">BoxDecoration</span><span class="p">(</span>
                    <span class="nl">borderRadius:</span> <span class="n">BorderRadius</span><span class="o">.</span><span class="na">all</span><span class="p">(</span>
                      <span class="n">Radius</span><span class="o">.</span><span class="na">circular</span><span class="p">(</span><span class="mi">18</span><span class="p">),</span>
                    <span class="p">),</span>
                    <span class="nl">color:</span> <span class="n">Colors</span><span class="o">.</span><span class="na">black</span><span class="p">),</span>
                <span class="nl">child:</span> <span class="n">Chart</span><span class="p">(</span><span class="n">_data</span><span class="p">),</span>
              <span class="p">),</span>
            <span class="p">),</span>
          <span class="p">],</span>
        <span class="p">),</span>
      <span class="p">),</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Here‚Äôs the working application:</p>

<div class="row mt-3">
    <div class="col-sm mt-3 pt-md-0 pl-xl-5 pr-xl-5">
    <div class="col-sm mt-3 pt-md-0 pl-xl-5 pr-xl-5">
    <div class="col-sm mt-3 pt-md-0 pl-xl-5 pr-xl-5">
    <div class="col-sm mt-3 pt-md-0 pl-xl-5 pr-xl-5">
        <img class="img-fluid rounded z-depth-1" src="/assets/img/posts/2020-04-08-ppg/app.gif" />
    </div>
    </div>
    </div>
    </div>
</div>
<div class="caption">
Application measuring the variation of blood flow on the index finger.
</div>

<p>The GitHub repository for this project can be found <a href="https://github.com/Afonsocraposo/ppg">here</a></p>

<p><strong>On my GitHub repository, you‚Äôll notice that I updated the application to using a <code class="language-plaintext highlighter-rouge">Timer.periodic</code>, which presented better results. I also added more customization and an animation the heart-shaped button that simulates a beating heart. I didn‚Äôt include it in this tutorial since its not necessary.</strong>
<br /></p>

  </article>

  
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname  = 'afonso';
      var disqus_identifier = '/blog/2020/ppg';
      var disqus_title      = "Measuring Your Heart Rate Using Your Phone‚Äôs Camera and Flutter";
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  

</div>

    </div>

    <!-- Footer -->

    
<footer class="sticky-bottom mt-5">
  <div class="container">
    &copy; Copyright 2022 Afonso  Raposo.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>.

    
    
    Last updated: October 17, 2022.
    
  </div>
</footer>



  </body>

  <!-- Bootsrap & MDB scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.4/umd/popper.min.js" integrity="sha512-eUQ9hGdLjBjY3F41CScH3UX+4JDSI9zXeroz7hJ+RteoCaY+GP/LDoM8AO+Pt+DRFw3nXqsjh9Zsts8hnYv8/A==" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js" integrity="sha512-Mug9KHKmroQFMLm93zGrjhibM2z2Obg9l6qFG2qKjXEXkMp/VDkI4uju9m4QKPjWSwQ6O2qzZEnJDEeCw0Blcw==" crossorigin="anonymous"></script>

  
<!-- Mansory & imagesLoaded -->
<script defer src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script defer src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script defer src="/assets/js/mansory.js" type="text/javascript"></script>


  


<!-- Load Common JS -->
<script src="/assets/js/common.js"></script>


</html>
